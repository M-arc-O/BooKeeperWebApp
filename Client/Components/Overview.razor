@using BooKeeperWebApp.Shared.Dtos;
@using BooKeeperWebApp.Shared.Dtos.Overview;

@inject OverviewService _overviewService

<PageTitle>BooKeeper</PageTitle>

<div class="container-fluid h-100">
    <div class="row">
        <div class="col-3">
            <RadzenCard>
                <div class="container-fluid h-100">
                    <div class="row">
                        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Accounts</RadzenText>
                    </div>
                    @if (_overviewService.LoadingAccounts)
                    {
                        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Loading accounts</RadzenText>
                        <RadzenProgressBar ProgressBarStyle="ProgressBarStyle.Primary" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                    }
                    else
                    {
                        @foreach (var account in _overviewService.Accounts)
                        {
                            <div class="row jusitify-content-left">
                                <div class="col-8">
                                    @account.AccountName
                                </div>
                                <div class="col-4 text-end">
                                    @account.Amount.ToString("N2")
                                </div>
                            </div>
                        }
                        <hr />
                        <div class="row jusitify-content-left rz-border-radius-4">
                            <div class="col-8">
                                Total
                            </div>
                            <div class="col-4 text-end">
                                @_overviewService.Accounts.Sum(x => x.Amount).ToString("N2")
                            </div>
                        </div>
                    }
                </div>
            </RadzenCard>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <RadzenCard>
                <div class="container-fluid h-100">
                    <div class="row">
                        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Books (@DateTime.Now.Year)</RadzenText>
                    </div>
                    <div class="row">
                        <div class="col-2">
                            <RadzenDropDown Data="@years" @bind-Value="selectedYear" Change="YearChanged" />
                        </div>
                    </div>
                    @if (_overviewService.LoadingBooks)
                    {
                        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Loading books</RadzenText>
                        <RadzenProgressBar ProgressBarStyle="ProgressBarStyle.Info" Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                    }
                    else
                    {
                        <RadzenDataGrid Data="@_overviewService.Books" TItem="OverviewBookDto"
                                    AllowPaging="true"
                                    PageSize="10"
                                    AllowSorting="true"
                                    AllowFiltering="true"
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    FilterMode="FilterMode.Simple">
                            <Columns>
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="BookName" Width="200px" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="JanuariAmount" Title="Januari" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="FebruariAmount" Title="Februari" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="MarchAmount" Title="March" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="AprilAmount" Title="April" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="MayAmount" Title="May" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="JuneAmount" Title="June" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="JulyAmount" Title="July" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="AugustAmount" Title="August" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="SeptemberAmount" Title="September" FormatString="{0:N2}" Width="110px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="OctoberAmount" Title="October" FormatString="{0:N2}" Width="95px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="NovemberAmount" Title="November" FormatString="{0:N2}" Width="105px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="DecemberAmount" Title="December" FormatString="{0:N2}" Width="105px" Filterable="false" TextAlign="TextAlign.Right" />
                                <RadzenDataGridColumn TItem="OverviewBookDto" Property="TotalAmount" Title="Total" FormatString="{0:N2}" Filterable="false" TextAlign="TextAlign.Right" />
                            </Columns>
                        </RadzenDataGrid>
                    }
                </div>
            </RadzenCard>
        </div>
    </div>
</div>

@code {
    private List<int> years = new();
    private int selectedYear;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        for (int i = 2020; i <= DateTime.Now.Year; i++)
        {
            years.Add(i);
        }
        selectedYear = DateTime.Now.Year;

        _overviewService.RefreshRequested += RefreshMe;
        _overviewService.LoadAccountsAsync();
        _overviewService.LoadBooksAsync(selectedYear);
    }

    private void YearChanged()
    {
        _overviewService.LoadBooksAsync(selectedYear);
    }

    public void Dispose()
    {
        _overviewService.RefreshRequested -= RefreshMe;
    }

    private void RefreshMe()
    {
        StateHasChanged();
    }
}
